---
- name: controller_bootstrap | request certificate
  docker_container:
    command: "{{ certbot_command }}"
    detach: no
    image: "{{ certbot_image }}"
    name: certbot
    network_mode: host
    state: started
    volumes:
      - "{{ letsencrypt_dir }}"
      - "{{ letsencrypt_data_dir }}"

- name: controller_bootstrap | load certificate
  shell: |
    let "count=0"
    for d in /etc/letsencrypt/live/* ; do
      if ! [ -f $d/fullchain.pem ]; then
        echo "Missing key for $d, skipping..."
      else
        cat $d/fullchain.pem $d/privkey.pem > /etc/haproxy/certs/lecert$count.pem
      fi
      ((count++))
    done
  args:
    warn: false
  no_log: True

# Can't use auto remove on orig certbot container due to ansible issues.
- name: controller_boootstrap | cleanup certbot
  docker_container:
    name: certbot
    state: absent

- name: controller_bootstrap | remove self-signed
  file:
    path: /etc/haproxy/certs/selfsigned.pem
    state: absent

- name: controller_boootstrap | restart haproxy
  service:
    name: haproxy
    state: restarted
