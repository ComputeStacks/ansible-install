---
- name: controller_bootstrap | request certificate
  docker_container:
    command: "{{ certbot_command }}"
    detach: no
    image: "{{ certbot_image }}"
    name: certbot
    network_mode: host
    container_default_behavior: compatibility
    state: started
    volumes:
      - "{{ letsencrypt_dir }}"
      - "{{ letsencrypt_data_dir }}"

- name: controller_bootstrap | load certificate
  command: /etc/cron.daily/cert_renew
  no_log: True
  args:
    warn: false

# Can't use auto remove on orig certbot container due to ansible issues.
- name: controller_boootstrap | cleanup certbot
  docker_container:
    name: certbot
    state: absent
    container_default_behavior: compatibility

- name: controller_bootstrap | remove self-signed
  file:
    path: /etc/haproxy/certs/selfsigned.pem
    state: absent

- name: controller_boootstrap | restart haproxy
  service:
    name: haproxy
    state: restarted
