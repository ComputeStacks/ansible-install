---
- name: pull image
  community.general.docker_image:
    name: "{{ prometheus_image }}"
    tag: "{{ prometheus_image_tag }}"
    source: pull

- name: create directories
  file:
    path: "/etc/prometheus"
    state: directory

- name: install files
  copy:
    src: "{{ item }}"
    dest: /etc/prometheus/
  loop:
    - alerts_node.yml
    - alerts_prometheus.yml

- name: install prom config
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml

- name: install alerts_containers
  template:
    src: alerts_containers.yml.j2
    dest: /etc/prometheus/alerts_containers.yml

- name: check if volume exists
  shell: docker volume inspect prometheus-data >/dev/null 2>&1
  register: prometheus_vol_exists
  ignore_errors: yes
  no_log: True
  vars:
    ansible_ssh_pipelining: no

- name: create prometheus volume
  community.general.docker_volume:
    name: prometheus-data
  when: prometheus_vol_exists is failed

- name: install systemd
  template:
    src: prometheus.service.j2
    dest: /etc/systemd/system/prometheus.service

- name: start prometheus
  systemd:
    name: prometheus
    state: started
    enabled: yes
    daemon_reload: yes
