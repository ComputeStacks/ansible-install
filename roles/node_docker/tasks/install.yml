---
- name: node_docker | check if certs exist
  stat:
    path: "{{ docker_key_file }}"
  register: key_exists

- include_tasks: certificates.yml
  when: key_exists.stat.exists == False
  
- name: node_docker | stop docker
  service:
    name: docker
    state: stopped

- name: node_docker | create docker startup directory
  file:
    path: /etc/systemd/system/docker.service.d
    state: directory
  
- name: node_docker | create docker startup script
  template:
    src: docker-startup.conf.j2
    dest: /etc/systemd/system/docker.service.d/startup.conf

- name: node_docker | reload systemd
  systemd: daemon_reload=yes

- name: node_docker | create user for containers
  user:
    name: dockremap
    uid: 1001
    shell: /bin/false
    create_home: no

- name: node_docker | start docker
  service:
    name: docker
    state: started